<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Shop Homepage - Start Bootstrap Template</title>
        <!-- Favicon-->
        <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
        <!-- Bootstrap icons-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="css/styles.css" rel="stylesheet" />
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"
      integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    </head>
    <body>
        <!-- Navigation-->
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container px-4 px-lg-5">
                <a class="navbar-brand" href="#!">키오스크</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0 ms-lg-4">
                        <li class="nav-item"><a class="nav-link active" aria-current="page" href="#!">Home</a></li>
                        <li class="nav-item"><a class="nav-link" href="#!">About</a></li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Shop</a>
                            <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                                <li><a class="dropdown-item" href="#!">All Products</a></li>
                                <li><hr class="dropdown-divider" /></li>
                                <li><a class="dropdown-item" href="#!">Popular Items</a></li>
                                <li><a class="dropdown-item" href="#!">New Arrivals</a></li>
                            </ul>
                        </li>
                    </ul>
                    <form class="d-flex">
                       <button class="btn btn-outline-dark" type="button" onclick="location.href='/login'">
                            <i class="bi-cart-fill me-1"></i>
                            관리자 로그인
                            <span class="badge bg-dark text-white ms-1 rounded-pill"></span>
                        </button>
                     </form>
                     <form class="d-flex">
                        <button class="btn btn-outline-dark" type="button" onclick="location.href='/cart'">
                            <i class="bi-cart-fill me-1"></i>
                            Cart
                            <span class="badge bg-dark text-white ms-1 rounded-pill">0</span>
                        </button>
                    </form>
                </div>
            </div>
        </nav>
        <!-- Header-->
        <header class="bg-dark py-5">
            <div class="container px-4 px-lg-5 my-5">
                <div class="text-center text-white">
                    <h1 class="display-4 fw-bolder">밀키트 전문점</h1>
                    <p class="lead fw-normal text-white-50 mb-0">간편한 조리로 한 끼 식사를 챙기세요 ! </p>
                </div>
            </div>
      </header>
      <div class="kind">
		<button class ="btn" value="0">전체</button>
		<button class ="btn" th:each="k:${kind}" th:value="${k.kindid}" th:text="${k.kindname}"></button>
      </div>
	      <!-- 하나의 인덱스 -->
        <!-- Section-->
        <section class="py-5">
                                
        	<div id="content">
             <h2>상품</h2>
             <table class="table table-bordered">
                <thead>
                   <tr>
                   	  <th>사진</th>
                   	  <th>번호</th>
                      <th>메뉴명</th>
                      <th>가격</th>
                      <th>종류</th>
                      <th>설명</th>
                      <th>담기</th>
                      
                   </tr>
                </thead>
                
                <tbody class="tr1"> 
				   <!-- tr의 값은 숨기지 않는 값(보여주는 것) value=1 로 설정 -->
                   <tr  th:if="${m.hide=='1'}" th:each='m : ${menus}' th:value="${m.hide}">
                   	<td></td>
                   	<td th:text="${m.menuid}" th:value="${m.stock}"></td>
                      <td th:text="${m.menuname}"></td>
                      <td th:text="${m.price}"></td>
                      <td th:text="${m.kind.kindname}"></td>
                      <td th:text="${m.ex}"></td>
                      <td>
                           <button th:if="${m.stock}>0" class="put" style="background-Color:rgb(0, 255, 128)"> 담기 </button>
                           <button th:if="${m.stock}<=0" class="put" style="background-Color:red"> 매진 </button>                                    
                      </td>
                   </tr>
                </tbody>
             </table>
         </div> 
         <hr><hr><hr>  
         <div class="basket">
			<h2>장바구니</h2> 
		     <table class="table table-bordered">
		        <thead>
		           <tr>
		           	  <th>사진</th>
		           	  <th>번호</th>
		              <th>메뉴명</th>
		              <th>가격</th>
		              <th>수량</th>
		              <th>삭제</th>		              
		           </tr>
				</thead>
				<!-- 장바구니 담기는 body-->
		        <tbody class="btr">             
				</tbody>
				<!-- 결제로 담기는 body -->
		        <tbody> 
		        	<tr>
		           	  <td> </td>
		           	  <td> </td>
		           	  <td> </td>
		           	  <td><label><input type="radio" name="pay" value="카드" checked> 카드</label>
      						<label><input type="radio" name="pay" value="현금"> 현금 </label>  </td>
		           	  <td class="sum"> 총액 : </td>
		              <td><button class="order"> 결제 </button>	</td>              
		           </tr>
		        </tbody>
		     </table>
      	</div> 
      	 <div class="total">
   
   		</div>                        
      </section>
      
      
        <!-- Footer-->
        <footer class="py-5 bg-dark">
            <div class="container"><p class="m-0 text-center text-white">Copyright &copy; Your Website 2021</p></div>
        </footer>
    <script>
    	// 카테고리값 배열로 저장
    	const kindnameAllname = [];		
		for(var i=0; i<$('.tr1').children().length; i++){
	 		kindnameAllname[i] = $('.tr1').children().eq(i).children().eq(4).text();
		}   
    	const trLength = $('.tr1').children().length;
    	const sum =$('.sum')
    	
    	// 카테고리 별로 조회
        $(function(){
			// 카테고리 버튼을 누르면 
			$('.btn').click((event)=>{
				const kindid = $(event.target).val();
				const kindname = $(event.target).text();		
  				const path = '/api/index';
				const json = JSON.stringify({				
					kind: {						
						'kindid': kindid,
						'kindname':kindname
					}
                });
                          
				$.ajax({
					url:path,
					type:'Post',
					contentType: 'application/json',
					data:json
				})
				.done((result)=>{
					const all = $('.tr1');
					all.empty();
					var tr = "";
					var td ="";
					for(var i=0; i<result.length; i++){
						td = ""
						tr = ""
						td += "<td>" + "</td>" 
						td += "<td value=\"" + result[i].stock + "\">" +result[i].menuid + "</td>"
						td += "<td>" +result[i].menuname + "</td>"
						td += "<td>" +result[i].price + "</td>"
						if(result.length == trLength){
						td += "<td>" +kindnameAllname[i] + "</td>"
						} else{
						td += "<td>" +kindname + "</td>"
						}
						td += "<td>" +result[i].ex + "</td>"
						if(result[i].stock > 0){
						td += "<td><button class=\"put\" style=\"background-Color:rgb(0, 255, 128)\">" + "담기" + "</button></td>";
						}else{
						td += "<td><button class=\"put\" style=\"background-Color:red\">" + "매진" + "</button></td>";
						}
						tr += "<tr class=\"tr" + i + "\">" + td + "</tr>";
						if(result[i].hide == '1')
							all.append(tr);
					}
					
					
				})
				.fail((result)=>{
					alert('카테고리 변경 실패'); 
				});
			});
		});
		
		//담기 눌렀을 떄
     	$(document).on('click', '.put', function () {
        	
	         const tbody2 = $('.btr');
	         const stock = $(this).closest("tr").children().eq(1).attr('value');
	         if(stock <= 0){
				alert("매진 상품입니다.")
				return false
			}
	         const menu_id = $(this).closest("tr").children().eq(1).text();
	         const menu_title = $(this).closest("tr").children().eq(2).text();
	         const menu_price = $(this).closest("tr").children().eq(3).text();
	         const menunum = tbody2.children().length;
	         let basketid = (menunum + 1);
	         var btr = "";
		     var btd = "";
	       	var check2 = [];
	  		var trindex
			 for(var j=0; j<basketid; j++){
				if(menu_title == $('.btr').children().eq(j).children().eq(2).text()){
					check2[j] = 0
				} else {
			 		check2[j] = 1	
				}
			}
			
			if(check2.includes(0)){
				// 장바구니에 이미 같은 메뉴가 있다면 해당메뉴 수량 +1, 금액 +
				console.log("장바구니에 이미 있음 -> 수량 +1")
				trindex = parseInt(check2.indexOf(0))
				var count = parseInt(tbody2.children().eq(trindex).children().eq(4).children().eq(1).html())+1
				tbody2.children().eq(trindex).children().eq(4).children().eq(1).html(count)	
				tbody2.children().eq(trindex).children().eq(4).children().eq(3).html(tbody2.children().eq(trindex).children().eq(3).html() * count)	 
			} else {
				// 장바구니에 이미 같은 메뉴가 없다면 담기
				 btr = ""
		         btd = ""
		         btd+= "<td>"+"</td>"
          		 btd+= "<td>"+menu_id+"</td>"
		         btd+= "<td>"+menu_title+"</td>"
		         btd+= "<td>"+menu_price+"</td>"
		         btd+= "<td><button class=\"min\">-</button>  <a>1</a>  <button class=\"plu\">+</button>  <a>"+menu_price+"</a></td>"
		         btd+= "<td>"+"<button class=\"delete\">삭제</button>"+"</td>"
			     btr+= "<tr value=\"" + stock + "\" name=\"aa\" class=btr" + menu_id + ">" + btd + "<tr>";
		         tbody2.append(btr);
		         tbody2.children().last().remove();
		         sum.html();
		         console.log("장바구니에 담음")
			}
			summ()
     	});
     	
     	var mcount
     	//수량감소
     	$(document).on('click', '.min', function () {
			const min=parseInt($(this).closest("td").children().eq(1).html())
			mcount = min-1
			if (min > 0){
			$(this).closest("td").children().eq(1).html(mcount)
			$(this).closest("td").children().eq(3).html($(this).closest("tr").children().eq(3).html() * mcount)
			}
			summ()
		});
		//수량추가
		$(document).on('click', '.plu', function () {
			const plu=parseInt($(this).closest("td").children().eq(1).html())
			mcount = plu+1
			$(this).closest("td").children().eq(1).html(mcount)
			$(this).closest("td").children().eq(3).html($(this).closest("tr").children().eq(3).html() * mcount)	
			summ()
		});
		//장바구니 메뉴 삭제			
		$(document).on('click', '.delete', function () {
			const remove = $(this).closest("tr").remove();
			const menunum = $('.btr').children().length;
			summ()
		});
		
		//결제버튼
		$(function(){
			$('.order').click((event)=>{
				const pay = $('input[name=pay]:checked').val();
				var stop=0;
				const stock = []
				const btr = $('.btr').children()
				const totalsum = ($('.sum').text());
				const basket = [];
				const bamount = [];
				for (var i=0; i<btr.length; i++){
					basket[i] = btr.eq(i).children().eq(1).html()
					bamount[i] = btr.eq(i).children().eq(4).children().eq(1).text()
					stock[i] = btr.eq(i).attr('value');
					if(parseInt(stock[i]) < parseInt(bamount[i])) {
						alert(basket[i]+"의 재고가 부족합니다. 현재 재고 : " + stock[i]);
						return false
					}
				
				}
				
				const path = '/api/odetail';
				const json = JSON.stringify({
						'basket':basket,
						'bamount':bamount,
						'sum':totalsum,
						'pay':pay
				});
				$.ajax({
						url:path,
						type:'Post',
						contentType: 'application/json',
						data:json
				})
				.done((result)=>{
						alert("결제완료!! \n주문번호 : "+result.totalsum+ "  결제시간 : "+result.orderedTime +"\n결제방법 : " + result.payway +"  결제금액 : "+result.totalsum); 
						
						var url = "http://localhost:9002/";
						window.location = url;
						window.location.replace(url);
						})
				.fail((result)=>{
						alert('상품 구매 실패'); 
			});
		});
		});
		
		//총액 보여주는 메소드
		function summ(){
			const menunum = $('.btr').children().length;
			var sum1 = 0
			for(var i=0; i<menunum; i++){
				sum1 += parseInt($('.btr').children().eq(i).children().eq(4).children().eq(3).html())
			}
			sum.html(sum1)
		}
	</script>
	<script>  
		
        </script>
        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="js/scripts.js"></script>
    </body>
</html>
